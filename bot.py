import os
import re
import random
import sqlite3
import logging
from datetime import datetime

import pytz
from aiogram import Bot, Dispatcher, Router, types, F
from aiogram.filters import Command, CommandStart

# ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# –¢–∞–π–º–∑–æ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ï—Ä–µ–≤–∞–Ω, –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Render)
TIMEZONE_NAME = os.getenv("TZ", "Asia/Yerevan")
TIMEZONE = pytz.timezone(TIMEZONE_NAME)

DB_PATH = "calories.db"
DEFAULT_DAILY_LIMIT = 2000  # –µ—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –∑–∞–¥–∞–Ω —è–≤–Ω–æ

# ---------- –õ–û–ì–ò ----------

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ---------- –ë–ê–ó–ê –î–ê–ù–ù–´–• ----------


def init_db():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    # –∫–∞–ª–æ—Ä–∏–∏ –ø–æ –¥–Ω—è–º
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS entries (
            user_id INTEGER,
            date TEXT,
            calories INTEGER,
            PRIMARY KEY (user_id, date)
        )
        """
    )

    # –¥–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS limits (
            user_id INTEGER PRIMARY KEY,
            daily_limit INTEGER
        )
        """
    )

    conn.commit()
    conn.close()


def get_today_date_str() -> str:
    now = datetime.now(TIMEZONE)
    return now.date().isoformat()


def add_calories(user_id: int, calories: int) -> int:
    """–î–æ–±–∞–≤–∏—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –≤–µ—Ä–Ω—É—Ç—å –∏—Ç–æ–≥ –∑–∞ –¥–µ–Ω—å."""
    date_str = get_today_date_str()
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        INSERT INTO entries (user_id, date, calories)
        VALUES (?, ?, ?)
        ON CONFLICT(user_id, date) DO UPDATE SET
            calories = calories + excluded.calories
        """,
        (user_id, date_str, calories),
    )
    conn.commit()

    cur.execute(
        "SELECT calories FROM entries WHERE user_id = ? AND date = ?",
        (user_id, date_str),
    )
    row = cur.fetchone()
    conn.close()
    return row[0] if row else calories


def get_today_calories(user_id: int) -> int:
    date_str = get_today_date_str()
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT calories FROM entries WHERE user_id = ? AND date = ?",
        (user_id, date_str),
    )
    row = cur.fetchone()
    conn.close()
    return row[0] if row else 0


def reset_today(user_id: int):
    date_str = get_today_date_str()
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "DELETE FROM entries WHERE user_id = ? AND date = ?",
        (user_id, date_str),
    )
    conn.commit()
    conn.close()


def set_limit_for_user(target_user_id: int, daily_limit: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        INSERT INTO limits (user_id, daily_limit)
        VALUES (?, ?)
        ON CONFLICT(user_id) DO UPDATE SET
            daily_limit = excluded.daily_limit
        """,
        (target_user_id, daily_limit),
    )
    conn.commit()
    conn.close()


def get_limit_for_user(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT daily_limit FROM limits WHERE user_id = ?",
        (user_id,),
    )
    row = cur.fetchone()
    conn.close()
    return row[0] if row else DEFAULT_DAILY_LIMIT


# ---------- –ü–ê–†–°–ò–ù–ì –ö–ê–õ–û–†–ò–ô ----------


def parse_calories_from_text(text: str) -> int | None:
    """
    –ü—Ä–∏–º–µ—Ä—ã:
    "450" -> 450
    "85 –Ω–∞ 2.7" -> round(85 * 2.7)
    "85 * 2.7" -> round(85 * 2.7)
    "100 + 50" -> 150
    """
    clean = text.lower().replace(",", ".")
    numbers = re.findall(r"\d+(?:\.\d+)?", clean)
    if not numbers:
        return None

    nums = [float(x) for x in numbers]

    # –µ—Å–ª–∏ –µ—Å—Ç—å "–Ω–∞", "x" –∏–ª–∏ "*" ‚Äî —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    if any(s in clean for s in [" –Ω–∞ ", " x ", " * ", "√ó"]):
        val = 1.0
        for n in nums:
            val *= n
    # –µ—Å–ª–∏ –µ—Å—Ç—å "+" ‚Äî —Å—á–∏—Ç–∞–µ–º —Å—É–º–º—É
    elif "+" in clean:
        val = sum(nums)
    else:
        # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞
        val = nums[0]

    return int(round(val))


# ---------- –†–ï–ê–ö–¶–ò–ò ----------

MEAL_REACTIONS = {
    "tiny": [
        "–≠—Ç–æ –Ω–µ –µ–¥–∞, –∞ —Ç–∏–∑–µ—Ä ü§è",
        "–ó–∞–∫—É—Å–∫–∞ —É—Ä–æ–≤–Ω—è ¬´—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑–æ—à—ë–ª—Å—è¬ª.",
        "–ú–∏–∫—Ä–æ-–ø–µ—Ä–µ–∫—É—Å, –æ—Ä–≥–∞–Ω–∏–∑–º –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—Ç–∏–ª.",
        "–ö–æ–º–∞—Ä —É–∫—É—Å—ã–≤–∞–ª —Å–∏–ª—å–Ω–µ–µ.",
        "–¢–∞–∫ —Ç—ã –∞–ø–ø–µ—Ç–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–∑–±—É–¥–∏–ª.",
        "–¢—Ä–µ–π–ª–µ—Ä –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º—É –æ–±–µ–¥—É.",
        "–ú–∏–Ω–∏-–∫–∞–ª–æ—Ä–∏–∏, –º–∏–Ω–∏-—É–≥—Ä—ã–∑–µ–Ω–∏—è —Å–æ–≤–µ—Å—Ç–∏.",
        "–ñ–∏–≤–æ—Ç —Ç–∞–∫–æ–π: ¬´–∏ —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ?¬ª",
        "–ó–∞–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏.",
        "–°–∫—Ä–æ–º–Ω–æ, –Ω–æ –º–∏–ª–æ.",
    ],
    "small": [
        "–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å, –∂–∏–≤—ë–º —Å–ø–æ–∫–æ–π–Ω–æ.",
        "–ù–æ—Ä–º —Ç–∞–∫–æ–π —Å–Ω—ç–∫, –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞.",
        "–û—Ä–≥–∞–Ω–∏–∑–º –¥–æ–≤–æ–ª–µ–Ω, —Å–æ–≤–µ—Å—Ç—å —Ç–æ–∂–µ.",
        "–ú–æ–∂–Ω–æ –≤–æ–æ–±—â–µ —Å–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ —ç—Ç–æ–≥–æ –Ω–µ –±—ã–ª–æ.",
        "–•–æ—Ä–æ—à–∏–π —Ç–µ–º–ø, –±–µ–∑ —Ä–∞–∑–≥–æ–Ω–∞ –≤ –±–µ–∑–¥–Ω—É –æ–±–∂–æ—Ä—Å—Ç–≤–∞.",
        "–ö–∞–ª–æ—Ä–∏–∏ –µ—Å—Ç—å, –ø–∞–Ω–∏–∫–∏ –Ω–µ—Ç.",
        "–°–∏–º–ø–∞—Ç–∏—á–Ω—ã–π –ø–µ—Ä–µ–∫—É—Å, –±–µ–∑ –¥—Ä–∞–º—ã.",
        "–¢–∞–∫ –º–æ–∂–Ω–æ —Ö–æ—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å.",
        "–ú–∏–Ω–∏-—Ä–∞–¥–æ—Å—Ç—å, –º–∏–Ω–∏-—É—â–µ—Ä–±.",
        "–¢–∏—Ö–∏–π –∫–∞–ª–æ—Ä–∏–π–Ω—ã–π —à–æ—Ä–æ—Ö.",
    ],
    "medium": [
        "–£–∂–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –µ–¥—É.",
        "–£–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏, –±–µ–∑ –∏–∑–ª–∏—à–∫–æ–≤.",
        "–ó–≤—É—á–∏—Ç –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±–µ–¥–µ–Ω–Ω—ã–π –∑–∞—Ö–æ–¥.",
        "–í–æ—Ç —ç—Ç–æ —É–∂–µ ¬´—è –ø–æ–µ–ª¬ª, –∞ –Ω–µ ¬´—è –ø–µ—Ä–µ–∫—É—Å–∏–ª¬ª.",
        "–û—Ä–≥–∞–Ω–∏–∑–º —Å—Ç–∞–≤–∏—Ç –ª–∞–π–∫.",
        "–î–æ—Å—Ç–æ–π–Ω–∞—è –ø–æ—Ä—Ü–∏—è, –±–µ–∑ —Ñ–ª–µ–∫—Å–∞.",
        "–ù–∏ –º–Ω–æ–≥–æ, –Ω–∏ –º–∞–ª–æ ‚Äî –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.",
        "–ü—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏, –±–µ–∑ —Å—é–∂–µ—Ç–Ω—ã—Ö —Ç–≤–∏—Å—Ç–æ–≤.",
        "–°—Ç–∞–±–∏–ª—å–Ω–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –±–µ–∑ –∏—Å—Ç–µ—Ä–∏–∫.",
        "–¢–∞–∫ –∏ —Ö—É–¥–µ—é—Ç, –µ—Å–ª–∏ —á—Ç–æ.",
    ],
    "big": [
        "–í–æ—Ç —ç—Ç–æ —É–∂–µ —Å–µ—Ä—å—ë–∑–Ω–æ.",
        "–ü–æ—Ä—Ü–∏—è —Å–∫–∞–∑–∞–ª–∞: ¬´–º—ã –∂–∏–≤—ë–º –æ–¥–∏–Ω —Ä–∞–∑¬ª.",
        "–¢—É—Ç —É–∂–µ –æ—Ä–≥–∞–Ω–∏–∑–º —Å–µ–ª –∑–∞ —Å—Ç–æ–ª –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.",
        "–ú–æ—â–Ω—ã–π –∑–∞—Ö–æ–¥, –Ω–æ –ø–æ–∫–∞ –±–µ–∑ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ.",
        "–ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è —É–≤–∞–∂–µ–Ω–∏–µ –∫ –µ–¥–µ.",
        "–≠—Ç–æ —É–∂–µ –Ω–µ –ø–µ—Ä–µ–∫—É—Å, —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ.",
        "–ñ–∏–≤–æ—Ç —Ç–∞–∫–æ–π: ¬´—Å–ø–∞—Å–∏–±–æ, –±—Ä–∞—Ç¬ª.",
        "–ü–ª–æ—Ç–Ω–æ —Ç–∞–∫, –ø–æ-–¥–æ–º–∞—à–Ω–µ–º—É.",
        "–ú–æ–∂–Ω–æ —á—É—Ç—å –ø–æ–ª–µ–∂–∞—Ç—å –ø–æ—Å–ª–µ —Ç–∞–∫–æ–≥–æ.",
        "–ö–∞–ª–æ—Ä–∏–∏ —Ç–∞–∫–∏–µ: ¬´–Ω–∞—Å —Ç—É—Ç –ø—Ä–∏–ª–∏—á–Ω–æ¬ª.",
    ],
    "huge": [
        "–ë–æ—Å—Å-—Ñ–∞–π—Ç –ø–æ –∫–∞–ª–æ—Ä–∏—è–º.",
        "–û—Ä–≥–∞–Ω–∏–∑–º —Ç–∞–∫–æ–π: ¬´–º—ã —Ç–æ—á–Ω–æ —ç—Ç–æ –≤—Å—ë —Å—ä–µ–ª–∏?¬ª",
        "–≠—Ç–æ —É–∂–µ –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",
        "–ü–ª–æ—Ç–Ω–æ –∑–∞—Ä—è–¥–∏–ª—Å—è, –º–æ–∂–Ω–æ –≤ –∑–∏–º–Ω—é—é —Å–ø—è—á–∫—É.",
        "–ì–µ—Ä–æ–π—Å–∫–∏–π –∑–∞—Ö–æ–¥, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ —Ç–∞–º.",
        "–ö–∞–∂–µ—Ç—Å—è, —ç—Ç–æ –±—ã–ª –Ω–µ ¬´—É–∂–∏–Ω¬ª, –∞ ¬´—É–¥–∞–≤¬ª.",
        "–ö–∞–ª–æ—Ä–∏–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ —Ç–∞–∫–∏–µ: ¬´–ø–æ –æ–¥–Ω–æ–º—É, –Ω–µ —Ç–æ–ª–ø–∏–º—Å—è¬ª.",
        "–û—á–µ–Ω—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ—Ä—Ü–∏—è.",
        "–ü–æ—Å–ª–µ —Ç–∞–∫–æ–≥–æ —Ö–æ—á–µ—Ç—Å—è —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Å—Ç–µ–Ω—É.",
        "–î–∏–µ—Ç–∞ —Ç–∏—Ö–æ –≤—ã—à–ª–∞ –∏–∑ —á–∞—Ç–∞.",
    ],
    "insane": [
        "–¢—ã —ç—Ç–æ –µ–ª –∏–ª–∏ –≤ –ø–æ—Ä—Ç–∞–ª —Å –∫–∞–ª–æ—Ä–∏—è–º–∏ —É–ø–∞–ª?",
        "–≠—Ç–æ –±—ã–ª —à–≤–µ–¥—Å–∫–∏–π —Å—Ç–æ–ª –≤ –æ–¥–∏–Ω–æ—á–∫—É?",
        "–û—Ä–≥–∞–Ω–∏–∑–º –ø–∏—à–µ—Ç –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ø—É—Å–∫.",
        "–ö–∞–ª–æ—Ä–∏–∏ —É—Å—Ç—Ä–æ–∏–ª–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤.",
        "–≠—Ç–æ –Ω–µ –µ–¥–∞, —ç—Ç–æ —Å—é–∂–µ—Ç–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç.",
        "–¢—É—Ç —É–∂–µ –∏–ª–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫, –∏–ª–∏ —Å—Ç—Ä–µ—Å—Å.",
        "–ú–∏—Å—Å–∏—è ¬´–Ω–∞–µ—Å—Ç—å—Å—è –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª –ø–æ—á—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.",
        "–ñ–µ–ª—É–¥–æ–∫ –ø–æ–¥–ø–∏—Å–∞–ª –º–∏—Ä–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä, –Ω–æ –Ω–µ —Å—Ä–∞–∑—É.",
        "–°–∏–ª—å–Ω—ã–π —Ö–æ–¥. –û—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π.",
        "–≠–ø–æ—Å, –∞ –Ω–µ –ø—Ä–∏—ë–º –ø–∏—â–∏.",
    ],
}

REMAIN_REACTIONS = {
    "very_low": [
        "–õ–∏–º–∏—Ç –ø–æ—á—Ç–∏ –ø—É—Å—Ç, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞—Ö.",
        "–ï—â—ë —á—É—Ç—å-—á—É—Ç—å ‚Äî –∏ —Ä–µ–∂–∏–º ¬´–≤–æ–∑–¥—É—Ö –∏ –Ω–∞–¥–µ–∂–¥–∞¬ª.",
        "–ó–∞–ø–∞—Å –Ω–∞ –∏—Å—Ö–æ–¥–µ, –¥–∞–ª—å—à–µ –ª—É—á—à–µ –¥—É–º–∞—Ç—å –¥–≤–∞–∂–¥—ã.",
        "–ö–∞–ª–æ—Ä–∏–π–Ω—ã–π –±–∞–∫ –ø–æ—á—Ç–∏ –Ω–∞ –Ω—É–ª–µ.",
        "–°–µ–π—á–∞—Å –±—ã —á—Ç–æ-–Ω–∏–±—É–¥—å –ª—ë–≥–∫–æ–µ, –∞ –Ω–µ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫.",
        "–§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è, –Ω–µ –ø–∞–¥–∞–π –Ω–∞ –Ω–µ–π.",
        "–°–∏—Ç—É–∞—Ü–∏—è ¬´–º–æ–∂–Ω–æ, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ¬ª.",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫—Ä–æ—Ö–∏ –ª–∏–º–∏—Ç–∞, –±–µ—Ä–µ–≥—ë–º.",
        "–õ—é–±–æ–π –ª–∏—à–Ω–∏–π –∫—É—Å–æ—á–µ–∫ —É–∂–µ —Å –¥—Ä–∞–º–æ–π.",
        "–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É ‚Äî –∏ –ª–∏–º–∏—Ç –º–∞—à–µ—Ç —Ä—É—á–∫–æ–π.",
    ],
    "low": [
        "–õ–∏–º–∏—Ç–∞ –º–∞–ª–æ, –Ω–æ –∂–∏—Ç—å –º–æ–∂–Ω–æ.",
        "–ü–æ—Ä–∞ –≤—ã–±–∏—Ä–∞—Ç—å –µ–¥—É —Å —É–º–æ–º, –∞ –Ω–µ —Å —ç–º–æ—Ü–∏–µ–π.",
        "–ó–∞–ø–∞—Å —Å–Ω–∏–∂–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.",
        "–ö–∞–ª–æ—Ä–∏–π–Ω—ã–π —Å—á—ë—Ç —Ç–∞–∫–æ–π: ¬´—è –±—ã —É–∂–µ –ø—Ä–∏—Ç–æ—Ä–º–æ–∑–∏–ª¬ª.",
        "–î–∞–ª—å—à–µ –ª—É—á—à–µ –±–µ–∑ –ø–æ–¥–≤–∏–≥–æ–≤.",
        "–°–∏—Ç—É–∞—Ü–∏—è ¬´–µ—â—ë –Ω–æ—Ä–º, –Ω–æ –Ω–∞ —Ç–æ–Ω–∫–æ–º –ª—å–¥—É¬ª.",
        "–ú–æ–∂–Ω–æ –ø–æ–µ—Å—Ç—å, –Ω–æ –±–µ–∑ —Ä–æ–∫-–∫–æ–Ω—Ü–µ—Ä—Ç–∞.",
        "–õ–∏–º–∏—Ç —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è.",
        "–ö–∞–∂–¥—ã–π –ø–µ—Ä–µ–∫—É—Å —Ç–µ–ø–µ—Ä—å —Å –ø–æ–¥—Ç–µ–∫—Å—Ç–æ–º.",
        "–°–µ—Ä—ã–π –ø–æ—è—Å –ø–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á—ë–Ω.",
    ],
    "medium": [
        "–ù–æ—Ä–º –±–∞–ª–∞–Ω—Å, –∂–∏—Ç—å –º–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ.",
        "–ó–∞–ø–∞—Å –µ—Å—Ç—å, –Ω–æ –Ω–µ –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã–π.",
        "–ò–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ —Ç—É–ø–∏—Ç—å —Å –≤—ã–±–æ—Ä–æ–º.",
        "–ú–æ–∂–Ω–æ –µ—Å—Ç—å –±–µ–∑ –ø–∞–Ω–∏–∫–∏, –Ω–æ —Å –≥–æ–ª–æ–≤–æ–π.",
        "–õ–∏–º–∏—Ç –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º, —Ç—ã —Ç–æ–∂–µ.",
        "–ü–æ–∫–∞ –≤—Å—ë –ø–æ –ø–ª–∞–Ω—É, –±–µ–∑ —Å—é—Ä–ø—Ä–∏–∑–æ–≤.",
        "–ú–æ–∂–Ω–æ –µ—â—ë –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏.",
        "–°–µ—Ä–µ–¥–∏–Ω–∫–∞: –Ω–µ –≥–æ–ª–æ–¥, –Ω–µ —Ä–∞–∑–Ω–æ—Å.",
        "–°—Ç–∞—Ç—É—Å: –∂–∏–≤—ë–º —Ä–∞–∑—É–º–Ω–æ.",
        "–î–∏–µ—Ç–∞ –º–æ–ª—á–∞ –æ–¥–æ–±—Ä—è–µ—Ç.",
    ],
    "high": [
        "–£ —Ç–µ–±—è –µ—â—ë –≤–∞–≥–æ–Ω –ª–∏–º–∏—Ç–∞, –Ω–µ –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä—É–π.",
        "–ú–æ–∂–Ω–æ –µ—Å—Ç—å –¥–æ–≤–æ–ª—å–Ω–æ —Å–º–µ–ª–æ, –Ω–æ –±–µ–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ¬´–Ω–∞ —Å–ø–æ—Ä¬ª.",
        "–ó–∞–ø–∞—Å —Ö–æ—Ä–æ—à–∏–π, –ø–∞–Ω–∏–∫–∏ –Ω–æ–ª—å.",
        "–õ–∏–º–∏—Ç –≤–æ–æ–±—â–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω –ø–æ–∫–∞.",
        "–ú–æ–∂–Ω–æ –æ—Å–æ–±–æ –Ω–µ –ø–∞—Ä–∏—Ç—å—Å—è –∑–∞ –∫–∞–∂–¥—ã–π –∫—É—Å–æ—á–µ–∫.",
        "–ö–∞–ª–æ—Ä–∏–π–Ω—ã–π —Å—á—ë—Ç –≤ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∑–æ–Ω–µ.",
        "–ú–æ–∂–µ—à—å –∂–∏—Ç—å –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —Ç–µ–Ω—å –¥–∏–µ—Ç—ã.",
        "–ó–∞–ø–∞—Å –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–∏—á–Ω—ã–π.",
        "–ü–æ–∫–∞ –¥–∞–∂–µ —Å–æ–≤–µ—Å—Ç—å –Ω–µ –≤–æ—Ä—á–∏—Ç.",
        "–¢—ã –∏–≥—Ä–∞–µ—à—å –Ω–∞ –ª—ë–≥–∫–æ–º —É—Ä–æ–≤–Ω–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.",
    ],
    "very_high": [
        "–õ–∏–º–∏—Ç –ø–æ—á—Ç–∏ –¥–µ–≤—Å—Ç–≤–µ–Ω–µ–Ω, –º–æ–∂–Ω–æ –∂–∏—Ç—å —à–∏—Ä–æ–∫–æ, –Ω–æ —Å –º–æ–∑–≥–æ–º.",
        "–°–µ–≥–æ–¥–Ω—è –µ—â—ë –¥–∞–∂–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª —Å–µ—Ä—å—ë–∑–Ω–æ –µ—Å—Ç—å.",
        "–ú–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏.",
        "–ó–∞–ø–∞—Å —Ç–∞–∫–æ–π, —á—Ç–æ –º–æ–∂–Ω–æ –∏ –¥–µ—Å–µ—Ä—Ç, –∏ —Å–æ–≤–µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.",
        "–ü–æ—Ö–æ–∂–µ, —Ç—ã —Å–µ–≥–æ–¥–Ω—è –æ—á–µ–Ω—å –∞–∫–∫—É—Ä–∞—Ç–µ–Ω.",
        "–ö–∞–ª–æ—Ä–∏–∏ —Ç–∞–∫–∏–µ: ¬´–∞ –º—ã —Ç—É—Ç –≤–æ–æ–±—â–µ –±—É–¥–µ–º?¬ª",
        "–î–∏–µ—Ç–∞ —Å–µ–≥–æ–¥–Ω—è –¥–∞–∂–µ –Ω–µ –Ω–∞–ø—Ä—è–≥–∞–ª–∞—Å—å.",
        "–ó–∞–ø–∞—Å —Ç–æ–ø–ª–∏–≤–Ω—ã–π –æ–≥—Ä–æ–º–Ω—ã–π.",
        "–ú–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∫—É—Å–Ω—ã–π –≤–µ—á–µ—Ä.",
        "–û—á–µ–Ω—å —á–∏—Å—Ç—ã–π –¥–µ–Ω—å –ø–æ–∫–∞, –Ω–µ –ª–æ–º–∞–π –µ–≥–æ –∑—Ä—è.",
    ],
    "over": [
        "–õ–∏–º–∏—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–∏—Ç. –ù–æ –º—ã —Ç—É—Ç –Ω–µ —Å—É–¥, –∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.",
        "–í—Å—ë, –ª–∏–º–∏—Ç —É–ª–µ—Ç–µ–ª. –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –Ω–µ —É—Å—É–≥—É–±–ª—è–π.",
        "–î–∏–µ—Ç–∞ —Ö–ª–æ–ø–Ω—É–ª–∞ –¥–≤–µ—Ä—å—é, –Ω–æ –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–∑–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –∑–∞–≤—Ç—Ä–∞.",
        "–ü–µ—Ä–µ–±–æ—Ä –ø–æ –ª–∏–º–∏—Ç—É, –∑–∞—Ç–æ —á–µ—Å—Ç–Ω–æ.", 
        "–°–µ–≥–æ–¥–Ω—è –ø–æ –∫–∞–ª–æ—Ä–∏—è–º –ø—Ä–∞–∑–¥–Ω–∏–∫, –∞ –Ω–µ –±—É–¥–Ω–∏.",
        "–ß—É—Ç—å –ø–µ—Ä–µ–ª–∏–º–∏—Ç–∏–ª ‚Äî –Ω–µ –∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞, –Ω–æ –ø–æ–º–µ—Ç–∏–º.",
        "–õ–∏–º–∏—Ç —Å–¥–∞–ª—Å—è, –Ω–æ —Ç—ã –Ω–µ—Ç.",
        "–°—Ç–∞—Ç—É—Å: ¬´–∂–∏–≤—ë–º, –∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ–º¬ª. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
        "–ü–µ—Ä–µ—à—ë–ª –≤ –∑–æ–Ω—É ¬´–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∑–∞–≤—Ç—Ä–∞¬ª.",
        "–ù—É –≤—Å—ë, —Ç–µ–ø–µ—Ä—å –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –≤–∏–Ω–∏—Ç—å —Å–µ–±—è, –∞ —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã.",
    ],
}


def get_meal_reaction(calories: int) -> str:
    if calories <= 150:
        bucket = "tiny"
    elif calories <= 300:
        bucket = "small"
    elif calories <= 500:
        bucket = "medium"
    elif calories <= 800:
        bucket = "big"
    elif calories <= 1200:
        bucket = "huge"
    else:
        bucket = "insane"
    return random.choice(MEAL_REACTIONS[bucket])


def get_remaining_reaction(used: int, limit_: int) -> str:
    if limit_ <= 0:
        return "–õ–∏–º–∏—Ç–∞ –Ω–µ—Ç, –∂–∏–≤—ë–º –ø–æ –æ—â—É—â–µ–Ω–∏—è–º."

    left = limit_ - used
    ratio_used = used / limit_

    if left < 0 or ratio_used >= 1.0:
        bucket = "over"
    elif ratio_used >= 0.9:
        bucket = "very_low"
    elif ratio_used >= 0.7:
        bucket = "low"
    elif ratio_used >= 0.4:
        bucket = "medium"
    elif ratio_used >= 0.15:
        bucket = "high"
    else:
        bucket = "very_high"

    return random.choice(REMAIN_REACTIONS[bucket])


def build_reaction(calories: int, used: int, limit_: int) -> str:
    """–†–∞–Ω–¥–æ–º–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Ä–µ–∞–∫—Ü–∏–∏: –ø–æ –ø—Ä–∏—ë–º—É –∏–ª–∏ –ø–æ –æ—Å—Ç–∞—Ç–∫—É."""
    if limit_ is None:
        # –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ —Å –ª–∏–º–∏—Ç–æ–º
        return get_meal_reaction(calories)

    if random.choice([True, False]):
        return get_meal_reaction(calories)
    else:
        return get_remaining_reaction(used, limit_)


# ---------- TELEGRAM-–ë–û–¢ ----------

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()
dp.include_router(router)


@router.message(CommandStart())
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    limit_ = get_limit_for_user(user_id)

    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ –¥–µ–Ω—å.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π –º–Ω–µ —á–∏—Å–ª–æ (–∏–ª–∏ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ `85 –Ω–∞ 2.7`), "
        "–∞ —è –±—É–¥—É –∫–æ–ø–∏—Ç—å –∏ –≥–æ–≤–æ—Ä–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ —É–∂–µ —Å—ä–µ–ª.\n\n"
        f"–¢–µ–∫—É—â–∏–π –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: {limit_} –∫–∞–ª–æ—Ä–∏–π.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/limit 2000 ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤–æ–π –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç\n"
        "/limit_for <user_id> 1800 ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n"
        "/today ‚Äî —Å–∫–æ–ª—å–∫–æ —É–∂–µ —Å—ä–µ–ª —Å–µ–≥–æ–¥–Ω—è\n"
        "/reset ‚Äî –æ–±–Ω—É–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å",
        parse_mode="Markdown",
    )


@router.message(Command("help"))
async def cmd_help(message: types.Message):
    await cmd_start(message)


@router.message(Command("limit"))
async def cmd_limit(message: types.Message):
    """
    /limit 2000 ‚Äî –∑–∞–¥–∞—Ç—å —Å–µ–±–µ
    /limit_for <user_id> <–∫–∞–ª–æ—Ä–∏–∏> ‚Äî –¥—Ä—É–≥–æ–π —Ö–µ–Ω–¥–ª–µ—Ä, —Å–º. –Ω–∏–∂–µ
    """
    parts = message.text.split()
    if len(parts) != 2:
        await message.answer("–§–æ—Ä–º–∞—Ç: /limit 2000")
        return

    try:
        value = int(parts[1])
        if value <= 0:
            raise ValueError
    except ValueError:
        await message.answer("–õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: /limit 1800")
        return

    user_id = message.from_user.id
    set_limit_for_user(user_id, value)
    await message.answer(f"–û–∫, —Ç–≤–æ–π –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Ç–µ–ø–µ—Ä—å {value} –∫–∞–ª–æ—Ä–∏–π.")


@router.message(Command("limit_for"))
async def cmd_limit_for(message: types.Message):
    """
    /limit_for <user_id> <–∫–∞–ª–æ—Ä–∏–∏>
    –ù–∞–ø—Ä–∏–º–µ—Ä: /limit_for 123456789 1800
    –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–∞—ë—Ç –ª–∏–º–∏—Ç –ø–æ user_id. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –±–ª–∏–∑–∫–∏—Ö.
    """
    parts = message.text.split()
    if len(parts) != 3:
        await message.answer("–§–æ—Ä–º–∞—Ç: /limit_for <user_id> <–∫–∞–ª–æ—Ä–∏–∏>")
        return

    try:
        target_id = int(parts[1])
        value = int(parts[2])
        if value <= 0:
            raise ValueError
    except ValueError:
        await message.answer("user_id –∏ –ª–∏–º–∏—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏. –ü—Ä–∏–º–µ—Ä: /limit_for 123456789 1800")
        return

    set_limit_for_user(target_id, value)
    await message.answer(f"–õ–∏–º–∏—Ç {value} –∫–∞–ª–æ—Ä–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è user_id={target_id}.")


@router.message(Command("today"))
async def cmd_today(message: types.Message):
    user_id = message.from_user.id
    used = get_today_calories(user_id)
    limit_ = get_limit_for_user(user_id)
    left = limit_ - used
    reaction = get_remaining_reaction(used, limit_)
    if left >= 0:
        text = (
            f"–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∂–µ —Å—ä–µ–ª {used} –∫–∞–ª–æ—Ä–∏–π.\n"
            f"–õ–∏–º–∏—Ç: {limit_}. –û—Å—Ç–∞–ª–æ—Å—å: {left}.\n\n"
            f"{reaction}"
        )
    else:
        text = (
            f"–°–µ–≥–æ–¥–Ω—è —Ç—ã —Å—ä–µ–ª {used} –∫–∞–ª–æ—Ä–∏–π.\n"
            f"–õ–∏–º–∏—Ç: {limit_}. –ü–µ—Ä–µ–±–æ—Ä: {abs(left)}.\n\n"
            f"{reaction}"
        )
    await message.answer(text)


@router.message(Command("reset"))
async def cmd_reset(message: types.Message):
    user_id = message.from_user.id
    reset_today(user_id)
    await message.answer("–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–∏ –æ–±–Ω—É–ª–µ–Ω—ã. –ö–∞–∫ –±—É–¥—Ç–æ –¥–µ–Ω—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è.")


@router.message(F.text)
async def handle_calorie_input(message: types.Message):
    # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã, –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    if message.text.startswith("/"):
        return

    cals = parse_calories_from_text(message.text)
    if cals is None or cals <= 0:
        await message.answer("–ù–µ –Ω–∞—à—ë–ª –∫–∞–ª–æ—Ä–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏. –ù–∞–ø–∏—à–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: `450` –∏–ª–∏ `85 –Ω–∞ 2.7`.",
                             parse_mode="Markdown")
        return

    user_id = message.from_user.id
    total = add_calories(user_id, cals)
    limit_ = get_limit_for_user(user_id)
    left = limit_ - total
    reaction = build_reaction(cals, total, limit_)

    if left >= 0:
        text = (
            f"+{cals} –∫–∞–ª–æ—Ä–∏–π.\n"
            f"–ó–∞ —Å–µ–≥–æ–¥–Ω—è: {total} –∏–∑ {limit_}. –û—Å—Ç–∞–ª–æ—Å—å: {left}.\n\n"
            f"{reaction}"
        )
    else:
        text = (
            f"+{cals} –∫–∞–ª–æ—Ä–∏–π.\n"
            f"–ó–∞ —Å–µ–≥–æ–¥–Ω—è: {total} –ø—Ä–∏ –ª–∏–º–∏—Ç–µ {limit_}. –ü–µ—Ä–µ–±–æ—Ä: {abs(left)}.\n\n"
            f"{reaction}"
        )

    await message.answer(text)


# ---------- MAIN ----------

async def main():
    init_db()
    logger.info("Bot started")
    await dp.start_polling(bot)


if __name__ == "__main__":
    import asyncio

    asyncio.run(main())
